#!/usr/bin/perl

use warnings;
use Net::IP::Match::XS;


#TBD
#Uc bilgileri ve ilgili IP adresleri dosyadan okunup arraylere aktarılacak

#hash of hash storing network info
my $ucNetworkInfo;

#hash of hash storing malware info
my $malInfo;

#hash of hash storing uc IP info, i.e. IP's found after filtering the flow using malicious IPs, i.e.  IP addresses communicated with malicious IPs
my $ucIPInfo;

sub parseUcNetworks {

	my($filename) = @_;

	open(FILE,$filename) or die "could not open the file";

	while (<FILE>) {
		
		chomp;
	
		#split by #
		($ucAdi,$ucNetwork) = split("\t");
		
		#get the number of stored uc networks for an uc (e.g. ULAKNET)
		$ucAdiSize = scalar(keys %{$ucNetworkInfo{$ucAdi}});
		
		$ucNetworkInfo{$ucAdi}{$ucAdiSize}=$ucNetwork;
			
	}
	
	close(FILE);

}

sub addMalInfo {

	my($infoName,$info) = @_;

	if ( $malInfo{$malwareIP}{$infoName} ) {
		if ($malInfo{$malwareIP}{$infoName} =~ m/$info/) {
			#match
		} else {
			#no match
			$malInfo{$malwareIP}{$infoName}=$malInfo{$malwareIP}{$infoName}." ".$info;
		}
	}
	else {
		$malInfo{$malwareIP}{$infoName}=$info;
	}

}

sub parseMalIPList {

	my($filename,$splitchar,$sourceName) = @_;
	system ("wget -O malFile.tmp $filename");

	open(FILE,"malFile.tmp") or die "could not open the file";
	
	$skiplineindex=1;
	while (<FILE>) {
		
		chomp;
		
		#skip first 5 lines
		if ($skiplineindex < 6) {
			$skiplineindex++;
			next;
		}
	
		#split by splitchar, for abuse.ch #
		($malwareIP,$malwareAdi) = split($splitchar);
		
		#trim left and right space
		$malwareIP =~ s/^\s+//;
		$malwareIP =~ s/\s+$//;
		$malwareAdi =~ s/^\s+//;
		$malwareAdi =~ s/\s+$//;
		
		
		#$malwareAdiSize = scalar(keys %{$malInfo{$malwareAdi}});
		
		$malPort=' ';
		
		&addMalInfo('Type',$malwareAdi);
		&addMalInfo('Source',$sourceName);
		&addMalInfo('Port',$malPort);
		
		$malInfo{$malwareIP}{'Count'}=0;
		
		#if ( $malInfo{$malwareIP}{'Count'} ) {
		#	$malInfo{$malwareIP}{'Count'}++;
		#}
		#else {
		#	$malInfo{$malwareIP}{'Count'}=1;
		#}
		#$malInfo{$malwareIP}{'Count'} = $malInfo{$malwareIP}{'Count'}++;
		#$malInfo{$malwareIP}{'Port'}= $malInfo{$malwareIP}{'Port'}." ";
		
	}
	
	close(FILE);
	
	#remove temp file
	#system ("rm malFile.tmp");
}



sub searchUcNetworksforMalIP {

	$numberOfDetection=0;
	for $i ( keys %ucNetworkInfo ) {
		for $j ( keys %{$ucNetworkInfo{$i}} ) {
			for $k ( keys %malInfo ) {
				
				if (match_ip( $k , $ucNetworkInfo{$i}{$j} )) {
					print "\n\n### Bad IP DETECTED!!!\n";
					print "Related Uc is ".$i."\n";
					print "Malicious IP: ".$k."\n";
					print "Port(s):".$malInfo{$k}{'Port'}."\n";
					print "Type(s): ".$malInfo{$k}{'Type'}."\n";
					print "Source(s): ".$malInfo{$k}{'Source'}."\n";
					print "Count: ".$malInfo{$k}{'Count'}."\n";
					$numberOfDetection++;
				}
				else {
					#Not detected
				}
				
			}
		}
	}
	print "\n\n### ";
	print $numberOfDetection." IP's are found.\n";

}

populateucIPInfo {
	
	$filter = "ip in [";
	for $k ( keys %malInfo ) {
	
		$filter .= $filter . " " . $k;
		
	}
	$filter .= " ]";


}

&parseUcNetworks("ucNetworkInfo.txt");
&parseMalIPList("http://amada.abuse.ch/blocklist.php?download=ipblocklist","#","Abuse.ch");

### Görev 1: bizim IPlerimiz botnetlist IPleri arasında yer alıyor mu? ###

&searchUcNetworksforMalIP;

### Görev 2: flowu $malInfo 'yu kullanarak filtrele, kalan IPleri $UcIPInfo hashine topla






exit;

